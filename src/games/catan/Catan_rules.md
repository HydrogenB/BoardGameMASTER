ด้านล่างคือ **“Catan (Base Game) Rules & Scenario Logic Spec”** แบบเขียนใหม่ (ไม่ก๊อปกฎจากหนังสือ) เพื่อให้คุณเอาไปแปะลงโค้ด/ทำ `scriptFactory` ได้เป็นระบบ ครอบคลุม setup + turn loop + edge cases หลัก ๆ

---

## 0) คำจำกัดความ (Entities / Components)

### ผู้เล่น (Player)

* `roads`: สูงสุด 15 ชิ้น
* `settlements`: สูงสุด 5 ชิ้น
* `cities`: สูงสุด 4 ชิ้น
* `handResources`: การ์ดทรัพยากร (brick/lumber/wool/grain/ore)
* `devCards`: การ์ดพัฒนาในมือ
* `playedKnightsCount`: จำนวน Knight ที่ “เล่นแล้ว” (ใช้สำหรับ Largest Army)
* `victoryPoints`: คำนวณจากสิ่งปลูกสร้าง + การ์ด + รางวัล

### ทรัพยากร (Resources)

* 5 ชนิด: `brick, lumber, wool, grain, ore`
* “ธนาคาร/กองกลาง” มีทรัพยากรจำกัด (อาจหมดได้)

### กระดาน (Board)

* `hex tiles` (ทรัพยากร) + `desert`
* `number tokens` 2–12 (ไม่มี 7 บนไทล์)
* `robber` อยู่บน 1 ไทล์เสมอ (เริ่มที่ desert)
* `ports` (2:1 เฉพาะทรัพยากร หรือ 3:1 ทั่วไป)

### สิ่งปลูกสร้าง

* Road: วางบน “ขอบ/edge”
* Settlement/City: วางบน “จุดตัด/vertex”
* ข้อจำกัดสำคัญ: Settlement/City **ห้ามติดกัน** (ต้องห่างอย่างน้อย 2 เส้นทาง)

---

## 1) เงื่อนไขชนะ (Victory)

* เป้าหมายปกติ: `10 VP`
* ชนะเมื่อ **ถึง/เกิน 10 VP ใน “ตาของตัวเอง”** และ “จบตา” (Host announce win)

### คะแนน VP (Base)

* Settlement = 1 VP
* City = 2 VP
* Longest Road (ถ้าถือครอง) = 2 VP
* Largest Army (ถ้าถือครอง) = 2 VP
* Victory Point dev cards = 1 VP ต่อใบ (ซ่อนจนประกาศ)

---

## 2) Setup Logic (Pre-game + Initial Placement)

### 2.1 ตั้งกระดาน (Board Setup)

3 โหมด (ตามที่คุณวางไว้ใน PRD)

* `BEGINNER`: จัดตามรูปแบบแนะนำ/ตายตัว (ง่าย)
* `RANDOMIZED`: สุ่มไทล์/ตัวเลข/พอร์ต (แต่ควรมีกฎเตือน “อย่าวาง 6 ติด 8” เป็น hint)
* `MANUAL`: โฮสต์จัดเอง

**เริ่มต้น**

* วาง robber ที่ `desert`

### 2.2 เลือกผู้เล่นเริ่ม (First player)

* สุ่ม หรือเลือกตามกติกาบ้าน
* เก็บ `currentPlayerIndex` ให้ชัด

### 2.3 วางบ้านเริ่มต้นแบบ “งู” (Snake order)

ผู้เล่นวาง **Settlement + Road ที่ติดกับ settlement นั้น** (ถนนต้องติดจุดที่วางบ้าน)

**Round 1 (ตามลำดับ)**

* A → B → C → D (หรือ 3 คน: A→B→C)

**Round 2 (ย้อนกลับ)**

* D → C → B → A

**หลังวาง Settlement รอบที่ 2**

* ผู้เล่น **รับทรัพยากรเริ่มต้น** จากไทล์ที่ติดกับ settlement รอบที่ 2 (ทุกไทล์ที่ติด ยกเว้น desert)
* Settlement รอบแรก **ไม่รับ** ทรัพยากรเริ่มต้น

### 2.4 กฎการวาง Settlement (สำคัญมาก)

* ต้องอยู่บน vertex ว่าง
* ต้องเว้นระยะ: vertex ที่ติดกัน (adjacent vertex) **ห้ามมี settlement/city** อยู่แล้ว
* ในช่วง setup: ไม่ต้องมี road เชื่อมมาก่อน (ยกเว้น road ที่วางคู่กันใน setup)

---

## 3) Turn Structure (ตาการเล่นหลัก)

ใน “ตาของผู้เล่น X” ให้ใช้โครงนี้ (คุณใช้เป็น rolling steps ได้เลย)

### 3.1 Start Turn

* แสดง: “เริ่มตา: ผู้เล่น X”

### 3.2 Roll Dice (ทอยลูกเต๋า)

ผลลัพธ์ 2–12

* ถ้า **ไม่ใช่ 7** → ไป “แจกทรัพยากร”
* ถ้า **ได้ 7** → เข้า “Robber Flow” ทันที

### 3.3 Resource Production (เมื่อไม่ใช่ 7)

สำหรับทุกไทล์ที่มีเลขตรงกับผลเต๋า:

* ถ้าไทล์นั้น **ไม่ถูก robber ทับ**

  * ผู้เล่นที่มี Settlement ติดไทล์นั้น รับทรัพยากร **1 ใบ**
  * ผู้เล่นที่มี City ติดไทล์นั้น รับทรัพยากร **2 ใบ**

**กรณีทรัพยากรในกองกลางไม่พอ (Bank shortage)**

* แนวทาง deterministic ที่แนะนำ (ง่ายและกันทะเลาะ):

  * ถ้า “จำนวนที่ต้องแจกทั้งหมด” > “จำนวนที่มีในกองกลาง” ⇒ **ทรัพยากรชนิดนั้น “ไม่แจกให้ใครเลย”** ในรอบนี้
    (เป็น rule handling ที่พบใช้บ่อยและเข้ากับ spirit ของเกม)

### 3.4 Trading Phase (เทรด)

เกิดในตาของผู้เล่นปัจจุบันเท่านั้น

* **Domestic trade**: เทรดกับผู้เล่นอื่นตามดีลที่ตกลงกันเอง
* **Maritime trade**: เทรดกับ bank

  * ปกติ: 4:1 (จ่ายทรัพยากรชนิดเดียว 4 ใบ แลก 1 ใบที่ต้องการ)
  * ถ้ามีพอร์ต 3:1: จ่าย 3 ใบชนิดเดียว
  * ถ้ามีพอร์ต 2:1 เฉพาะทรัพยากร: จ่าย 2 ใบชนิดนั้น
* หมายเหตุ: ทำได้ “กี่ครั้งก็ได้” ถ้าทรัพยากรพอ

### 3.5 Build / Actions Phase (สร้าง/อัปเกรด/ซื้อ dev)

ผู้เล่นทำได้หลายครั้งในตาตัวเอง ตราบเท่าที่จ่ายทรัพยากรได้

**ค่าใช้จ่าย**

* Road: `brick + lumber`
* Settlement: `brick + lumber + wool + grain`
* City: `ore*3 + grain*2`
* Dev card: `ore + wool + grain`

**Building rules**

* Road:

  * ต้องวางบน edge ว่าง
  * ต้อง “ต่อกับ” network ของตัวเอง: adjacent to existing road **หรือ** adjacent to own settlement/city
* Settlement (ระหว่างเกม):

  * ต้องวางบน vertex ว่าง
  * ต้องห่างจาก settlement/city อื่นอย่างน้อย 2 edges (distance rule)
  * ต้องต่อกับ road ของตัวเองอย่างน้อย 1 เส้น (อยู่ปลาย road)
* City:

  * อัปเกรด settlement ของตัวเองเท่านั้น
  * เอา settlement กลับเข้ากองผู้เล่น (ไม่หายไป)
* Piece limit:

  * ถ้าชิ้นนั้นหมด (เช่น settlements ใช้ครบ 5) ⇒ สร้างเพิ่มไม่ได้จนกว่าจะอัปเกรดเป็น city เพื่อคืน settlement มา

### 3.6 Development Cards (ซื้อ/เล่น)

เด็คพื้นฐาน (จำนวนโดยทั่วไป):

* Knight 14
* Victory Point 5
* Road Building 2
* Monopoly 2
* Year of Plenty 2

**ข้อจำกัดการเล่น dev**

* โดยหลัก: “ใน 1 เทิร์น เล่น dev card ได้สูงสุด 1 ใบ”
  (ยกเว้น Victory Point ที่มักนับเป็นการ “เปิดเผยคะแนน” มากกว่า “เล่นเอฟเฟกต์” — ให้คุณกำหนดเป็น rule engine: VP เปิดเผยได้เมื่อไหร่ก็ได้ในเทิร์นเพื่อเช็คชนะ)
* dev card ที่ “เพิ่งซื้อในเทิร์นนี้” **ห้ามใช้เอฟเฟกต์** ในเทิร์นเดียวกัน (ยกเว้น VP reveal ตามการออกแบบของคุณ)

**เอฟเฟกต์การ์ด (Logic)**

* Knight:

  * ย้าย robber → เลือกผู้เล่นที่มีสิ่งปลูกสร้างติดไทล์นั้นเพื่อ “ขโมยการ์ดทรัพยากร 1 ใบแบบสุ่ม”
  * เพิ่ม `playedKnightsCount +1` เพื่อเช็ครางวัล Largest Army
* Road Building:

  * วาง road ฟรี 2 เส้น (ต้องถูกกฎการวาง road)
  * ถ้าวางได้จริงแค่ 1 เส้น (เพราะชิ้นหมด/ไม่มีตำแหน่งถูกต้อง) ⇒ วางเท่าที่ทำได้
* Year of Plenty:

  * เลือกทรัพยากร 2 ใบจาก bank (ชนิดเดียวกันได้)
  * ถ้า bank มีไม่พอ ⇒ หยิบได้เท่าที่มี (0–2)
* Monopoly:

  * เลือกทรัพยากร 1 ชนิด
  * ผู้เล่นอื่น “ต้องให้” การ์ดทรัพยากรชนิดนั้นทั้งหมดที่มีแก่ผู้ใช้การ์ด
* Victory Point:

  * เก็บเป็นความลับ จนผู้เล่นเลือกเปิดเผยเพื่อรวมคะแนน

### 3.7 End Turn

* แสดง “จบตา: ส่งให้ผู้เล่นถัดไป”
* เปลี่ยน `currentPlayerIndex`
* ถ้าครบรอบ (วนกลับผู้เล่นเริ่ม) ⇒ `roundNumber + 1`
* เช็คชนะ: ถ้า VP ≥ target ⇒ ประกาศชนะแล้วจบเกม (status COMPLETED)

---

## 4) Robber Flow (กรณีทอยได้ 7 หรือเล่น Knight)

### 4.1 Trigger

* ได้ 7 จากการทอยเต๋า **หรือ**
* เล่น Knight card

### 4.2 Discard Rule (เฉพาะกรณี “ทอยได้ 7”)

* ผู้เล่นที่มีการ์ดทรัพยากรในมือ **มากกว่า 7 ใบ** ต้องทิ้ง “ครึ่งหนึ่ง” (ปัดเศษลง)

  * 8 ใบทิ้ง 4
  * 9 ใบทิ้ง 4
  * 10 ใบทิ้ง 5
  * 11 ใบทิ้ง 5
  * 12 ใบทิ้ง 6
* ผู้เล่นที่มี 7 หรือน้อยกว่า **ไม่ทิ้ง**

### 4.3 Move Robber

* ผู้เล่นปัจจุบันเลือกไทล์ใหม่ให้ robber ไปอยู่
* ไทล์ที่ถูก robber ทับจะ “ไม่ผลิตทรัพยากร” เมื่อเลขนั้นออก

### 4.4 Steal (ขโมย)

* ถ้ามี settlement/city ของผู้เล่นอื่นติดกับไทล์ใหม่:

  * ผู้เล่นปัจจุบันเลือก “หนึ่งผู้เล่น” จากกลุ่มนั้น แล้วสุ่มขโมยทรัพยากร 1 ใบ
* ถ้าไม่มีผู้เล่นติดไทล์ หรือเป้าหมายไม่มีการ์ด ⇒ ขโมยไม่ได้

### 4.5 Return to Turn

* ถ้าทอยได้ 7: หลัง robber จบ → กลับไป “ช่วงเทรด/สร้าง” ของผู้เล่นปัจจุบัน
* ถ้าใช้ Knight: กลับไปทำ action ต่อในเทิร์นนั้น (ยังเป็นเทิร์นเดิม)

---

## 5) Longest Road (ตรรกะ + edge cases)

**เกณฑ์ถือครอง**

* ต้องมีความยาว “ถนนต่อเนื่อง” อย่างน้อย 5 เส้น
* ถ้ามีคนถืออยู่แล้ว ต้อง “มากกว่า” ความยาวของเจ้าของเดิมเพื่อแย่ง (เท่ากันไม่เปลี่ยนมือ)

**การนับความต่อเนื่อง**

* ถนนต้องเชื่อมกันเป็นเส้นต่อเนื่อง (path)
* “ทางแยก” ทำให้ต้องเลือกเส้นทางที่ยาวสุด (ไม่สามารถนับรวมกิ่งพร้อมกัน)
* “วงกลม/loop” นับได้ตามเส้นทางต่อเนื่องที่ยาวสุด
* **ถ้ามี settlement/city ของผู้เล่นอื่นวางคั่นที่จุดตัด** จะ “ตัด” เส้นทางถนน ทำให้ longest road อาจสั้นลงและอาจเสียรางวัลได้

**Scenario logic**

* ถ้าความยาวลดลงจนไม่มากที่สุดแล้ว ⇒ รางวัลอาจย้าย (ต้องคำนวณใหม่ทุกครั้งที่มีการวาง settlement/city บนจุดตัดที่ไปตัดถนน)

> Implementation tip: ไม่ต้องทำ perfect graph algorithm ใน MVP ก็ได้ แต่ถ้าจะทำให้ถูก: model เป็น graph edges owned by player และคำนวณ longest simple path โดยมี node-blocking จาก opponent buildings.

---

## 6) Largest Army (ตรรกะ)

* ได้เมื่อผู้เล่น “เล่น Knight แล้ว” อย่างน้อย 3 ใบ
* ถ้ามีคนถืออยู่แล้ว ต้อง “มากกว่า” จำนวน Knight ที่เล่นแล้วของเจ้าของเดิม (เท่ากันไม่เปลี่ยน)

---

## 7) Trading Scenarios (ที่คนชอบงง)

1. **เทรดกับผู้เล่นอื่น** ทำได้เฉพาะ “ตาของผู้เล่นปัจจุบัน”
2. **เทรดกับ bank/port** ก็ทำได้เฉพาะ “ตาของผู้เล่นปัจจุบัน”
3. **port 2:1** ใช้ได้เมื่อจ่าย “ทรัพยากรชนิดเดียวกับพอร์ต” เท่านั้น
4. **port 3:1** ใช้ได้กับทรัพยากรชนิดใดก็ได้ (แต่ต้องจ่ายชนิดเดียวต่อดีล)

---

## 8) Edge Cases (ควรทำเป็น “Scenario Cards” ในระบบคุณ)

รายการนี้เหมาะกับการทำ quick action / checkpoint / helper steps

### A) Bank shortage

* แจกไม่พอ ⇒ ไม่แจกทรัพยากรชนิดนั้นให้ใครในรอบนั้น (แนะนำ)

### B) Robber + steal target none

* วาง robber แล้วไม่มีผู้เล่นติด ⇒ ข้ามการขโมย

### C) Road Building card วางไม่ครบ

* วางได้เท่าที่ legal และมีชิ้น (0–2)

### D) Year of Plenty bank ไม่พอ

* หยิบได้เท่าที่มี (0–2)

### E) ซื้อ dev แล้วอยากใช้เลย

* ปฏิเสธ (ยกเว้น VP reveal ตาม design ของคุณ)

### F) บรรลุ 10 VP กลางเทิร์น

* เกม “จบ” เมื่อผู้เล่นประกาศ/เช็คแล้วในเทิร์นของตัวเอง และจบตา (host finalize)

---

## 9) แปลงเป็น “Step Scripts” สำหรับ Rolling Lyric (ตัวอย่างโครง)

คุณสามารถทำ step generator ตาม state machine:

### Phase: SETUP

* steps เตรียมกระดาน

### Phase: PLACEMENT_R1 / PLACEMENT_R2

* step ต่อผู้เล่น:

  * “ผู้เล่น X: วางบ้าน + ถนน”
  * helper: “ห้ามติดบ้านคนอื่น (ต้องเว้น 2 ช่อง)”
* หลัง PLACEMENT_R2 ของผู้เล่น X:

  * “รับทรัพยากรเริ่มต้นจากบ้านหลังที่ 2”

### Phase: TURN_LOOP

สำหรับผู้เล่น X:

1. “เริ่มตา: ผู้เล่น X”
2. “ทอยลูกเต๋า”
3. “แจกทรัพยากรตามผล (ถ้า 7 เรียกโหมดโจร)”
4. “ช่วงเทรด”
5. “ช่วงสร้าง/อัปเกรด/ซื้อ dev”
6. “จบตา: ส่งให้ผู้เล่นถัดไป”

### Subflow: ROBBER

* discard steps (เฉพาะกรณีทอย 7)
* move robber
* steal
* “กลับไปช่วงเทรด/สร้างของผู้เล่น X”

---

## 10) สิ่งที่ต้องถามคุณ (ก่อน “แปะลงโค้ด” แบบไม่ย้อนแก้)

มี 5 จุดที่เป็น “กติกาบ้าน” บ่อยมาก ถ้าคุณเลือกตอนนี้ จะทำให้ script ชัด:

1. ตอน **แจกไม่พอ**: ใช้กติกา “ไม่แจกให้ใคร” ใช่ไหม?
2. **VP dev card**: ให้ “เปิดได้ตอนไหนก็ได้ในเทิร์น” หรือ “นับเป็น 1 dev/turn”?
3. **Friendly robber**: เปิดไหม? (เช่น ห้ามวาง robber ทับผู้เล่นที่ยัง <3 VP)
4. **จับเวลาเทิร์น**: ต้องการ timer UI จริงไหม หรือแค่ reminder step?
5. ต้องการรองรับ **5–6 คน** ตั้งแต่แรกไหม?

ถ้าคุณตอบ 5 ข้อนี้ ผมจะเขียนเป็น **script ภาษาไทยแบบพร้อมวางลง `strings.th.ts` + `scriptFactory.ts`** ให้ตรงกับระบบคุณแบบไม่ต้องเดา.
